/**
 *Submitted for verification at testnet.snowtrace.io on 2022-06-15
*/

// SPDX-License-Identifier: MIT

/*                                                                                          
wₕʸ ʸoᵤ ʷₐnᵗ ₜo ᴾlₐy ₜhⁱₛ ˢₕᴵt?   
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#BP55GGP5Y55PPPGGB##&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#BGYYYYY55555YYYYYYYYY555GB&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#@@B5YYYYYYYYPPPPPPPPPPPPPPPPPGPPPGB&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@5YYPPPPP55PPPP5YYJJJJJJJJJJYY5YY55PPGGGBB#&@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@&#BGGGGGP5YYJJJJYJJJJJJJJJJJJ?PJ!Y5Y?PJJJ5PGG55P#@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@&[email protected]@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@&[email protected]@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@B5Y5YYYYYYYYYYYYYY5555BBYJJJJJJ???JJJJJYYYY555PPPPPGPGYYPG&@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@#P5555YYYYYYYYYYYYYYYY555PBG5YYYY5GGBBBBBBGGGGPP5YYJJJJB#[email protected]@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@&P55555YYYYYYYYYYYYYYYYYYY555PGGGGGGPP55555555555PGGGGGPG#B55PGG#@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@PPG[email protected]@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@&B#PYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY555555555PGPP5555#@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@#P55YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYBP5555P&@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@G555YYY[email protected]@@@@@@@@@@@@@@@
@@@@@@@@@@@@@&P555YYYY[email protected]@@@@@@@@@@@@@@
@@@@@@@@@@@@B5555YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY5555555#@@@@@@@@@@@@@@@
@@@@@@@@@@@#P555YYYYY[email protected]@@@@@@@@@@@@@@@
@@@@@@@@@@GYYYYYYYYYYYYYYYYYYPG###[email protected]@@@@@@@@@@@@@@@
@@@@@@@@@@P5YYYYYYYYYYYYYYYYG&#BGGGB##[email protected]@@@@@@@@@@@@@@@@
@@@@@@@@@@&G55P5YYYYYYYYY5Y5&#5Y5YYYY##[email protected]@@@@@@@@@@@@@@@@
@@@@@@@@@@[email protected]#GGPYYYY5P55YYYYYYYYYYYGBBBB&#BP5YYYYYYYY55555&@@@@@@@@@@@@@@@@
@@@@@@@@@@&P55YY555YYYYYYYPB##5YYYYP#[email protected]@@@@@@@@@@@@@@@
@@@@@@@@@@@&5555555YYYYYYYY5B##BGGBBPPPYY5P5YYYYYYYYYY5GPYYP#[email protected]@@@@@@@@@@@@@@@
@@@@@@@@@@@&555555YYYYYYYYYY5GBGGGPPPP5PP55YYYYYYYYYY5Y?JB5Y5GBBBBPP5YYYYYYYYY55555B#5B&@@@@@@@@@@@@
@@@@@@@@@@@@#P55555YYYYYYYYYYY55PPPP5555YYYYYYYYYYYYYJJ?!5BG55PP5YYYYYYYYYYYYY55555G#555P#@@@@@@@@@@
@@@@@@@@@@@@&BBG5GG55YYYYYYYYYYYYYYYYYYYYYYYYYYYYYPBP?!!JY?7?!!JGPYYYYYYYYYYYY55555P#JY5P5P#@@@@@@@@
@@@@@@@@@@@B5P5GB5GGB5YYYYYYYYYYYYYYYYYYYYYYYYYYYG#5J~!!?7^!J5~~?#YYYYYYYYYYYP55555BGJJJYPG5P#@@@@@@
@@@@@@@@@#PYPYJY#555#B5YYYYYYYYYYY555PYYYYYYYYY5B57Y7~~!J?!?7!!7GPYYYY55PYYYPG5555P#[email protected]@@@
@@@@@@@#P55YJJJY#5555BG55YYYYYYYYY5P#PYYYYYYYYY#Y!77~~!!!!7J7!!GGYYB#[email protected]@
@@@@@B555YJJJJJ5B#555555P5YYYYYYYYYYBGYYYYYYYY5&[email protected]#[email protected]#[email protected]
@@@#YYP5JJJJYJJY&@B555555YYYYYYYYYYY5&#G5YYYYYY5GBG555JJ5GPPGP5YYYBGYYY55555P55B#@@@&##&#GPBBGPGB5Y&
@@[email protected]@@[email protected]#5YYYYYYYYY5PPPPGGP55YYYYYG#[email protected]@@@@@@@@@@@@@@@@@&@
@GJGYJJ5YJJ5GP#@@@@&P5555555YYYYYYYYYYG&&G55YYYYYYYYYYYYYYYYY5PB#[email protected]@@@@@@@@@@@@@@@@@@@
@YP5Y5GGYY5#@@@@@@@@@B5555555555YYYYYYYYPGGGGGPP555555PPPPGB#[email protected]@@@@@@@@@@@@@@@@@@@@
#Y&&@@@@@@@@@@@@@@@@@@&G5555555555YYYYYYYYYY555PPG#&##BBGPGBPYYYYY5555555555G&@@@@@@@@@@@@@@@@@@@@@@
&[email protected]@@@@@@@@@@@@@@@@@@@@@&G55555555555555555555PPPPPP5555555555555555555555G#@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@&BG5555555555555555555555555555555555555555555P#@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#GP555555555555555555555555555555555555PB#@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#BGPP55555555555555555555555555PG#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&BBGGPPPPPP555555555PPGB#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#B#&&#&@@[email protected]&&&BBBB##&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&##@&#&&#&JJG#&BPGGB&B#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##&GG5YYY??JY5J?YYG&G&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##B#BG?JYYJ?J55YJBB####&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B&B#B&#BBG5JYYJ?Y&B####@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#GGB#&#####B###B##B#&&#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@P7???G##B&&B#B#B#&&[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@YJB?77JY55Y?5#BGPPJ5#[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&[email protected]?#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@GJ#Y?5P555PGGPPGPYJJ?BP?#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@P#[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&P&[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                                                                                            
*/

pragma solidity ^0.8.13;

contract GoblinShiter {

    // constants
    uint constant AMOEBA_TO_BREEDING_BREEDER = 1080000;
    uint constant PSN = 10000;
    uint constant PSNH = 5000;

    // attributes
    uint public marketAmoeba;
    uint public startTime = 6666666666;
    address public owner;
    address public address2;
    mapping (address => uint) private lastBreeding;
    mapping (address => uint) private breedingBreeders;
    mapping (address => uint) private claimedAmoeba;
    mapping (address => uint) private tempClaimedAmoeba;
    mapping (address => address) private referrals;
    mapping (address => ReferralData) private referralData;

    // structs
    struct ReferralData {
        address[] invitees;
        uint rebates;
    }

    // modifiers
    modifier onlyOwner {
        require(msg.sender == owner, "not owner");
        _;
    }

    modifier onlyOpen {
        require(block.timestamp > startTime, "not open");
        _;
    }

    modifier onlyStartOpen {
        require(marketAmoeba > 0, "not start open");
        _;
    }

    // events
    event Create(address indexed sender, uint indexed amount);
    event Merge(address indexed sender, uint indexed amount);

    constructor() {
        owner = msg.sender;
        address2 = 0xF9A27151BA8De161e523E9be84d4f2216D48E446;
    }

    // Create Amoeba
    function createAmoeba(address _ref) external payable onlyStartOpen {
        uint amoebaDivide = calculateAmoebaDivide(msg.value, address(this).balance - msg.value);
        amoebaDivide -= devFee(amoebaDivide);
        uint fee = devFee(msg.value);

        (bool ownerSuccess, ) = owner.call{value: fee * 80 / 100}("");
        require(ownerSuccess, "owner pay failed");
        (bool address2Success, ) = address2.call{value: fee * 20 / 100}("");
        require(address2Success, "address2 pay failed");

        claimedAmoeba[msg.sender] += amoebaDivide;
        divideAmoeba(_ref);

        emit Create(msg.sender, msg.value);
    }

    // Divide Amoeba
    function divideAmoeba(address _ref) public onlyStartOpen {
        if (_ref == msg.sender || _ref == address(0) || breedingBreeders[_ref] == 0) {
            _ref = owner;
        }

        if (referrals[msg.sender] == address(0)) {
            referrals[msg.sender] = _ref;
            referralData[_ref].invitees.push(msg.sender);
        }

        uint amoebaUsed = getMyAmoeba(msg.sender);
        uint newBreeders = amoebaUsed / AMOEBA_TO_BREEDING_BREEDER;
        breedingBreeders[msg.sender] += newBreeders;
        claimedAmoeba[msg.sender] = 0;
        lastBreeding[msg.sender] = block.timestamp > startTime ? block.timestamp : startTime;
        
        // referral rebate
        uint amoebaRebate = amoebaUsed * 13 / 100;
        if (referrals[msg.sender] == owner) {
            claimedAmoeba[owner] += amoebaRebate * 80 / 100;
            claimedAmoeba[address2] += amoebaRebate * 20 / 100;
            tempClaimedAmoeba[owner] += amoebaRebate * 80 / 100;
            tempClaimedAmoeba[address2] += amoebaRebate * 20 / 100;
        } else {
            claimedAmoeba[referrals[msg.sender]] += amoebaRebate;
            tempClaimedAmoeba[referrals[msg.sender]] += amoebaRebate;
        }
        
        marketAmoeba += amoebaUsed / 5;
    }

    // Merge Amoeba
    function mergeAmoeba() external onlyOpen {
        uint hasAmoeba = getMyAmoeba(msg.sender);
        uint amoebaValue = calculateAmoebaMerge(hasAmoeba);
        uint fee = devFee(amoebaValue);
        uint realReward = amoebaValue - fee;

        if (tempClaimedAmoeba[msg.sender] > 0) {
            referralData[msg.sender].rebates += calculateAmoebaMerge(tempClaimedAmoeba[msg.sender]);
        }
        
        // dev fee
        (bool ownerSuccess, ) = owner.call{value: fee * 80 / 100}("");
        require(ownerSuccess, "owner pay failed");
        (bool address2Success, ) = address2.call{value: fee * 20 / 100}("");
        require(address2Success, "address2 pay failed");

        claimedAmoeba[msg.sender] = 0;
        tempClaimedAmoeba[msg.sender] = 0;
        lastBreeding[msg.sender] = block.timestamp;
        marketAmoeba += hasAmoeba;

        (bool success1, ) = msg.sender.call{value: realReward}("");
        require(success1, "msg.sender pay failed");
    
        emit Merge(msg.sender, realReward);
    }

    //only owner
    function seedMarket(uint _startTime) external payable onlyOwner {
        require(marketAmoeba == 0);
        startTime = _startTime;
        marketAmoeba = 108000000000;
    }

    function amoebaRewards(address _address) public view returns(uint) {
        uint hasAmoeba = getMyAmoeba(_address);
        return calculateAmoebaMerge(hasAmoeba);
    }

    function getMyAmoeba(address _address) public view returns(uint) {
        return claimedAmoeba[_address] + getAmoebaSinceLastDivide(_address);
    }

    function getClaimAmoeba(address _address) public view returns(uint) {
        return claimedAmoeba[_address];
    }

    function getTempClaimAmoeba(address _address) public view returns(uint) {
        return tempClaimedAmoeba[_address];
    }

    function getLastAmoeba(address _address) public view returns(uint) {
        return getAmoebaSinceLastDivide(_address);
    }
    
    function getPoolAmount() public view returns(uint) {
        return address(this).balance;
    }
    
    function getBreedingBreeders(address _address) public view returns(uint) {
        return breedingBreeders[_address];
    }

    function getReferralData(address _address) public view returns(ReferralData memory) {
        return referralData[_address];
    }

    function getReferralAllRebate(address _address) public view returns(uint) {
        return referralData[_address].rebates;
    }

    function getReferralAllInvitee(address _address) public view returns(uint) {
       return referralData[_address].invitees.length;
    }

    function calculateAmoebaMerge(uint amoeba) public view returns(uint) {
        return calculateTrade(amoeba, marketAmoeba, address(this).balance);
    }

    function calculateTrade(uint256 rt,uint256 rs, uint256 bs) private pure returns(uint) {
        return (PSN * bs) / (PSNH + ((PSN * rs + PSNH * rt) / rt));
    }

    function calculateAmoebaDivide(uint _eth,uint _contractBalance) private view returns(uint) {
        return calculateTrade(_eth, _contractBalance, marketAmoeba);
    }
    
    function getAmoebaSinceLastDivide(address _address) private view returns(uint) {
        if (block.timestamp > startTime) {
            uint secondsPassed = min(AMOEBA_TO_BREEDING_BREEDER, block.timestamp - lastBreeding[_address]);
            return secondsPassed * breedingBreeders[_address];     
        } else {
            return 0;
        }
    }

    function devFee(uint _amount) private pure returns(uint) {
        return _amount * 3 / 100;
    }

    function min(uint a, uint b) private pure returns (uint) {
        return a < b ? a : b;
    }
}